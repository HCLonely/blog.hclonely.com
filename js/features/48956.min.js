"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),Util={leftDistance:function(t){for(var e=t.offsetLeft,i=void 0;t.offsetParent;)t=t.offsetParent,e+=t.offsetLeft;return i=document.body.scrollLeft+document.documentElement.scrollLeft,e-i},timeFormat:function(t){var e=parseInt(t/60),i=parseInt(t%60);return(e<10?"0"+e:e)+":"+(i<10?"0"+i:i)},percentFormat:function(t){return(100*t).toFixed(2)+"%"},ajax:function(t){t.beforeSend&&t.beforeSend();var e=new XMLHttpRequest;e.onreadystatechange=function(){4===e.readyState&&(e.status>=200&&e.status<300?t.success&&t.success(e.responseText):t.fail&&t.fail(e.status))},e.open("GET",t.url),e.send(null)}},instance=!1,baseUrl="https://api.i-meto.com/meting/api",skPlayer=function(){function t(e){var i=this;if(_classCallCheck(this,t),instance)return console.error("SKPlayer只能存在一个实例！"),Object.create(null);instance=!0;var s={element:document.getElementById("skPlayer"),autoplay:!1,mode:"listloop",listshow:!0};for(var o in s)e.hasOwnProperty(o)||(e[o]=s[o]);if(this.option=e,!(this.option.music&&this.option.music.type&&this.option.music.source))return console.error("请正确配置对象！"),Object.create(null);this.root=this.option.element,this.type=this.option.music.type,this.music=this.option.music.source,this.media=this.option.music.media,this.isMobile=/mobile/i.test(window.navigator.userAgent),this.isReady=!1,this.toggle=this.toggle.bind(this),this.toggleList=this.toggleList.bind(this),this.toggleMute=this.toggleMute.bind(this),this.switchMode=this.switchMode.bind(this),"file"===this.type?(this.root.innerHTML=this.template(),this.init(),this.bind(),this.isReady=!0):"meting"===this.type&&(this.root.innerHTML='<p class="skPlayer-tip-loading"><span></span> <span></span> <span></span> <span></span><span></span></p>',Util.ajax({url:baseUrl+"?server="+this.media+"&type=playlist&id="+this.music,beforeSend:function(){},success:function(t){i.music=JSON.parse(t),i.root.innerHTML=i.template(),i.init(),i.bind()},fail:function(t){console.error("歌单拉取失败！ 错误码："+t)}}))}return _createClass(t,[{key:"notice",value:function(t,e){$.message({title:LocalConst.MUSIC_NOTICE,message:t,type:e})}},{key:"template",value:function(){var t='\n            <audio class="skPlayer-source" src="'+("meting"===this.type?this.music[0].url:"")+'" preload="auto"></audio>\n            <div class="skPlayer-picture">\n                <img class="skPlayer-cover" src="'+this.music[0].pic+'" alt="">\n    \n            </div>\n            <div class="skPlayer-control">\n                <p class="skPlayer-name">'+this.music[0].title+'</p>\n                <div class="playController"><div onclick="player.prev();" class="lastMusic  music-off "><span class="feathericons"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg></span></div> &nbsp;&nbsp;\n <div class="runMusic  music-off skPlayer-play-btn"><span class="runMusicIcon feathericons"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></span></div>&nbsp;&nbsp; \n <div onclick="player.next();" class="nextMusic  music-off "><span class="feathericons"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg></span></div></div>\n                <p class="skPlayer-author">'+this.music[0].author+'</p>\n                <div class="skPlayer-percent">\n                    <div class="skPlayer-line-loading"></div>\n                    <div class="skPlayer-line lter"></div>\n                </div>\n                <p class="skPlayer-time">\n                    <span class="skPlayer-cur">00:00</span>/<span class="skPlayer-total">00:00</span>\n                </p>\n                <div class="skPlayer-volume" style="'+(this.isMobile?"display:none;":"")+'">\n                    <span class="feathericons skPlayer-volume-icon"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></span>\n                    <div class="skPlayer-percent">\n                        <div class="skPlayer-line"></div>\n                    </div>\n                </div>\n                <i class="'+("singleloop"===this.option.mode?"skPlayer-mode skPlayer-mode-loop":"skPlayer-mode")+'"></i>\n            </div>\n            <ul id="skPlayer-list" class="skPlayer-list animated flipInX">\n        ';for(var e in this.music)t+='\n                <li data-index="'+e+'">\n                    <i class="skPlayer-list-sign"></i>\n                    <span class="skPlayer-list-index">'+(parseInt(e)+1)+'</span>\n                    <span class="skPlayer-list-name" title="'+this.music[e].title+'">'+this.music[e].title+'</span>\n                    <span class="skPlayer-list-author" title="'+this.music[e].author+'">'+this.music[e].author+"</span>\n                </li>\n            ";return t+="\n            </ul>\n        "}},{key:"init",value:function(){var t=this;if(this.dom={cover:this.root.querySelector(".skPlayer-cover"),playbutton:this.root.querySelector(".skPlayer-play-btn"),runIcon:this.root.querySelector(".skPlayer-play-btn .runMusicIcon"),name:this.root.querySelector(".skPlayer-name"),author:this.root.querySelector(".skPlayer-author"),timeline_total:this.root.querySelector(".skPlayer-percent"),timeline_loaded:this.root.querySelector(".skPlayer-line-loading"),timeline_played:this.root.querySelector(".skPlayer-percent .skPlayer-line"),timetext_total:this.root.querySelector(".skPlayer-total"),timetext_played:this.root.querySelector(".skPlayer-cur"),volumebutton:this.root.querySelector(".skPlayer-volume-icon"),volumeline_total:this.root.querySelector(".skPlayer-volume .skPlayer-percent"),volumeline_value:this.root.querySelector(".skPlayer-volume .skPlayer-line"),switchbutton:this.root.querySelector(".skPlayer-list-switch"),modebutton:this.root.querySelector(".skPlayer-mode"),musiclist:this.root.querySelector(".skPlayer-list"),musicitem:this.root.querySelectorAll(".skPlayer-list li")},this.audio=this.root.querySelector(".skPlayer-source"),this.option.listshow&&(this.root.className="skPlayer-list-on"),"singleloop"===this.option.mode&&(this.audio.loop=!0),this.dom.musicitem[0].className="skPlayer-curMusic","meting"===this.type){if(this.option.autoplay&&!this.isMobile){var e=!0;$.message({title:"音乐播放",message:"即将自动播放，点击<a class='stopMusic'>停止播放</a>",type:"warning"}),setTimeout(function(){e&&t.play()},3050)}$(".stopMusic").click(function(){e=!1,$(".c-message--close").click()})}"cloud"===this.type&&Util.ajax({url:baseUrl+"?type=song&media="+this.media+"&id="+this.music[0].song_id,beforeSend:function(){},success:function(e){var i=JSON.parse(e).url;if(null!==i)t.isReady=!0,t.audio.src=i;else{var s=parseInt(t.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index"));t.errorHandle(s)}if(t.option.autoplay&&!t.isMobile){var o=!0;$.message({title:"音乐播放",message:"即将自动播放，点击<a class='stopMusic'>停止播放</a>",type:"warning"}),setTimeout(function(){o&&t.play()},3050)}$(".stopMusic").click(function(){o=!1,$(".c-message--close").click()})},fail:function(t){console.error("歌曲拉取失败！ 错误码："+t)}})}},{key:"bind",value:function(){var t=this;this.updateLine=function(){var e=t.audio.buffered.length?t.audio.buffered.end(t.audio.buffered.length-1)/t.audio.duration:0;t.dom.timeline_loaded.style.width=Util.percentFormat(e)},this.audio.addEventListener("durationchange",function(e){t.dom.timetext_total.innerHTML=Util.timeFormat(t.audio.duration),t.updateLine()}),this.audio.addEventListener("progress",function(e){t.updateLine()}),this.audio.addEventListener("canplay",function(t){}),this.audio.addEventListener("error",function(e){if(t.isReady){var i=parseInt(t.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index"));t.errorHandle(i)}}),this.audio.addEventListener("timeupdate",function(e){var i=t.audio.currentTime/t.audio.duration;t.dom.timeline_played.style.width=Util.percentFormat(i),t.dom.timetext_played.innerHTML=Util.timeFormat(t.audio.currentTime)}),this.audio.addEventListener("seeked",function(e){t.play()}),this.audio.addEventListener("ended",function(e){t.next()}),this.dom.playbutton.addEventListener("click",this.toggle),this.isMobile||this.dom.volumebutton.addEventListener("click",this.toggleMute),this.dom.modebutton.addEventListener("click",this.switchMode),this.dom.musiclist.addEventListener("click",function(e){var i=void 0,s=void 0,o=void 0;if("LI"===e.target.tagName.toUpperCase())i=e.target;else{if("LI"!==e.target.parentElement.tagName.toUpperCase())return;i=e.target.parentElement}s=parseInt(i.getAttribute("data-index")),o=parseInt(t.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index")),s===o?t.play():t.switchMusic(s+1)}),this.dom.timeline_total.addEventListener("click",function(e){var i=e||window.event,s=(i.clientX-Util.leftDistance(t.dom.timeline_total))/t.dom.timeline_total.clientWidth;isNaN(t.audio.duration)||(t.dom.timeline_played.style.width=Util.percentFormat(s),t.dom.timetext_played.innerHTML=Util.timeFormat(s*t.audio.duration),t.audio.currentTime=s*t.audio.duration)}),this.isMobile||this.dom.volumeline_total.addEventListener("click",function(e){var i=e||window.event,s=(i.clientX-Util.leftDistance(t.dom.volumeline_total))/t.dom.volumeline_total.clientWidth;t.dom.volumeline_value.style.width=Util.percentFormat(s),t.audio.volume=s,t.audio.muted&&t.toggleMute()})}},{key:"prev",value:function(){var t=parseInt(this.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index"));0===t?1===this.music.length?this.play():this.switchMusic(this.music.length-1+1):this.switchMusic(t-1+1)}},{key:"next",value:function(){var t=parseInt(this.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index"));t===this.music.length-1?1===this.music.length?this.play():this.switchMusic(1):this.switchMusic(t+1+1)}},{key:"errorHandle",value:function(t){this.dom.musicitem[t].classList.add("invalid-name"),$.message({title:LocalConst.MUSIC_NOTICE,message:LocalConst.MUSIC_FAILE_END,type:"error"})}},{key:"sleep",value:function(t){for(var e=Date.now();Date.now-e<=t;);}},{key:"switchMusic",value:function(t){var e=this;return"number"!=typeof t?void console.error("请输入正确的歌曲序号！"):(t-=1)<0||t>=this.music.length?void console.error("请输入正确的歌曲序号！"):t==this.dom.musiclist.querySelector(".skPlayer-curMusic").getAttribute("data-index")?void this.play():(this.dom.musiclist.querySelector(".skPlayer-curMusic").classList.remove("skPlayer-curMusic"),this.dom.musicitem[t].classList.add("skPlayer-curMusic"),this.dom.name.innerHTML=this.music[t].title,this.dom.author.innerHTML=this.music[t].author,this.dom.cover.src=this.music[t].pic,void("meting"===this.type?void 0!==this.music[t].url?(this.audio.src=this.music[t].url,this.isReady=!0,this.play()):this.errorHandle(t):"cloud"===this.type&&Util.ajax({url:baseUrl+"?type=song&media="+this.media+"&id="+this.music[t].song_id,beforeSend:function(){},success:function(t){var i=JSON.parse(t).url;null!==i?(e.audio.src=i,e.isReady=!0,e.play()):1!==e.music.length&&e.next()},fail:function(t){console.error("歌曲拉取失败！ 错误码："+t)}})))}},{key:"play",value:function(){this.audio.paused&&(this.audio.play(),this.dom.playbutton.classList.add("skPlayer-pause"),this.dom.cover.classList.add("skPlayer-pause"),this.dom.runIcon.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>')}},{key:"pause",value:function(){this.audio.paused||(this.audio.pause(),this.dom.playbutton.classList.remove("skPlayer-pause"),this.dom.cover.classList.remove("skPlayer-pause"),this.dom.runIcon.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>')}},{key:"toggle",value:function(){this.audio.paused?this.play():this.pause()}},{key:"toggleList",value:function(){this.root.classList.contains("skPlayer-list-on")?this.root.classList.remove("skPlayer-list-on"):this.root.classList.add("skPlayer-list-on")}},{key:"toggleMute",value:function(){this.audio.muted?(this.audio.muted=!1,this.dom.volumebutton.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',this.dom.volumeline_value.style.width=Util.percentFormat(this.audio.volume)):(this.audio.muted=!0,this.dom.volumebutton.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',this.dom.volumeline_value.style.width="0%")}},{key:"switchMode",value:function(){this.audio.loop?(this.audio.loop=!1,this.dom.modebutton.classList.remove("skPlayer-mode-loop")):(this.audio.loop=!0,this.dom.modebutton.classList.add("skPlayer-mode-loop"))}},{key:"destroy",value:function(){instance=!1,this.audio.pause(),this.root.innerHTML="";for(var t in this)delete this[t]}}]),t}();
